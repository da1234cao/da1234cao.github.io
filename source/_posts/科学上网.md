---
title: 搭建v2ray服务以科学上网
date: 2021-10-30 19:52
categories: 
- 杂项知识点
tags:
- v2ray
excerpt: 搭建v2ray服务以科学上网
---

## 了解背景

[翻墙软件VPN推荐，中国仅2款好用](https://github.com/vpncn/vpncn.github.io)、[2021便宜好用的VPS推荐，美国香港VPS避坑攻略](https://vpsda.github.io/)、[gcorelabs服务商](https://gcorelabs.com/about/)

## 配置主机

[ssh服务配置](https://blog.csdn.net/sinat_38816924/article/details/120561158)

## v2ray服务器端搭建

[V2Ray一键安装脚本](https://github.com/233boy/v2ray/wiki/V2Ray%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC)

## v2ray客户端安装

windows/linux：[Qv2ray](https://qv2ray.net/getting-started/)

安卓：[Kitsunebi](https://github.com/eycorsican/kitsunebi-android)

ipad：[Kitsunebi](https://apps.apple.com/us/app/kitsunebi-proxy-utility/id1446584073)

## 问题处理1

突然有天，梯子的Ipv4不能走代理，Ipv6还可以走代理。

测试了下IP没有被封。端口也正常。不知道为啥子。

干脆换下端口试试。好家伙，试试就逝世。这些IPv6也没法正常用了。

没了google，使用必应上网搜搜，总算解决了问题。我不知道为什么是这样解决，但它确实解决了问题。

解决方法：[app/proxyman/inbound: connection ends > proxy/vmess/inbound: invalid request from](https://github.com/v2ray/v2ray-core/issues/2966)、[ proxy/vmess/encoding: invalid user](https://github.com/233boy/v2ray/issues/812)

第一步：change AlterID to 0 for file /usr/local/etc/v2ray/config.json in server and client.

第二步：/lib/systemd/system/v2ray.service中新加了一行Environment="V2RAY_VMESS_AEAD_FORCED=false"。

第三步重启： systemctl daemon-reload; systemctl restart v2ray

## 问题处理2

ip被封了，又租了台新的，但是租住之后才知道新租的服务器ip也是被屏蔽的。没租之前，ip没有对应的系统，无法知道是否被屏蔽，白白花钱。

所以，我切换使用[vultr](https://www.vultr.com/zh/)。按小时收费的。如果开出一台服务器的ip是被屏蔽的，重新开一台就好。

所以，我按照上面一样搭建服务。但是搭建起来的服务，非常非常难用，经常无法访问。

我查看了客户端的日志，没有发现问题。我抓取客户端的数据包，可以看到客户端在不停的重传数据，虽然服务端的access.log里面已经显示收到客户端的请求。

这就比较难办了。没有google，排查错误都很慢。后来看到[2021年11月份开始V2Ray很难成功访问成功](https://github.com/v2fly/v2ray-core/discussions/1383),j将传输使用的tcp协议改成kcp协议，意外的好了。

为什么好了，不知道，暂时能用了。迟早有天，我看下v2ray的源码。网络相关的代码是比较有意思的内容。

## 问题处理3

(ipv4+)端口被封，修复过程。

* ping 下 -- 可以ping通；ip没有被封
* 经测试，端口被封 -- 修改服务端口
* 登录服务器，输入`v2ray` 命令，根据提示修改端口，修改端口后重启服务
* 修改防火墙，放行上面端口
* 测试，仍然未通过。查看`/etc/v2ray/config.json`配置文件，发现修改端口的时候，协议从kcp转换为tcp。修改协议为kcp。重启服务
* 测试，通过。


## 使用tls

申请个免费域名：[freenom](https://www.freenom.com)

配置个tls：[v2ray-TLS](https://toutyrater.github.io/advanced/tls.html)

## 其他

* [IP端口可用性在线检测工具](https://www.toolsdaquan.com/ipcheck/)
* [Ubuntu20.04 防火墙设置](https://blog.csdn.net/cljdsc/article/details/120832554)
* [Linux 查看端口占用情况](https://www.runoob.com/w3cnote/linux-check-port-usage.html)
* [v2ray查看日志](https://github.com/233boy/v2ray/issues/631)